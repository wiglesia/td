<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Admin - Panel de Gesti√≥n</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Variables y Reset B√°sico */
        :root {
            --color-bg-dark: #121212;
            --color-bg-light: #1e1e1e;
            --color-primary: #00bcd4; /* Azul cian vibrante */
            --color-secondary: #ff9800; /* Naranja para advertencias/√©nfasis */
            --color-success: #4CAF50;
            --color-danger: #F44336;
            --color-text-light: #e0e0e0;
            --color-border: #333;
            --font-stack: 'Poppins', sans-serif;
            
            /* Nuevos colores para Dashboard */
            --color-indigo: #3f51b5;
            --color-teal: #009688;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-stack);
            margin: 0;
            padding: 0;
            background-color: var(--color-bg-dark);
            color: var(--color-text-light);
            display: flex;
            min-height: 100vh;
        }

        /* Estilos del Sidebar y Contenido Principal */
        .sidebar {
            width: 250px;
            background-color: var(--color-bg-light);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            padding: 2rem 0;
            position: fixed; 
            top: 0;
            left: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
            transform: translateX(-250px); 
        }

        .sidebar.open {
            transform: translateX(0);
        }
        
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            width: 100%;
            margin-left: 0;
            transition: margin-left 0.3s ease-in-out;
        }
        
        @media (min-width: 992px) {
            .sidebar {
                position: sticky; 
                transform: translateX(0); 
            }
            body {
                display: flex; 
            }
            .main-content {
                margin-left: 250px; 
                padding-top: 2rem;
            }
            .menu-toggle {
                display: none !important; 
            }
            header {
                padding-top: 0 !important;
            }
        }
        
        .menu-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: var(--color-primary);
            color: var(--color-bg-dark);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            font-size: 1.2rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 3rem;
            color: var(--color-primary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .nav-links button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 1rem 2rem;
            border: none;
            background: none;
            color: var(--color-text-light);
            text-align: left;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, border-left 0.3s;
            border-left: 5px solid transparent;
        }

        .nav-links button i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .nav-links button:hover,
        .nav-links button.active {
            background-color: rgba(0, 188, 212, 0.1);
            color: var(--color-primary);
            border-left: 5px solid var(--color-primary);
        }
        
        .nav-links .logout-btn {
            margin-top: auto; 
            border-top: 1px solid var(--color-border);
            padding-top: 1rem;
        }

        header {
            background: none;
            color: var(--color-text-light);
            padding: 0 0 2rem 0;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 2rem;
            padding-top: 50px; 
        }
        header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .form-section {
            display: none;
            background: var(--color-bg-light);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--color-border);
            margin-bottom: 2rem;
        }

        .form-section.active {
            display: block;
        }
        
        /* Contenedor del Login (Full Screen) */
        #login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg-dark);
            z-index: 2000; 
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s;
        }

        #login-container.hidden {
            display: none;
        }

        .login-box {
            background: var(--color-bg-light);
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0, 188, 212, 0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h2 {
            color: var(--color-primary);
            margin-bottom: 2rem;
        }
        
        .login-box input {
            margin-bottom: 1.5rem;
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background-color: var(--color-bg-dark);
            color: var(--color-text-light);
            font-size: 1rem;
        }

        .login-box button {
            width: 100%;
            background: var(--color-primary);
            color: var(--color-bg-dark);
            padding: 0.75rem;
        }

        /* Estilos del resto del ADMIN (Card, Form, etc.) */
        
        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        form label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--color-primary);
        }

        form input, form select, form textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background-color: var(--color-bg-dark);
            color: var(--color-text-light);
            font-family: var(--font-stack);
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        form input:focus, form select:focus, form textarea:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.5);
            outline: none;
        }

        form textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-action-group {
            grid-column: 1 / -1; 
            display: flex;
            justify-content: flex-end;
            padding-top: 1rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s, transform 0.1s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        form button[type="submit"] {
            background: var(--color-success);
            color: var(--color-bg-dark);
        }

        form button[type="submit"]:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        /* Estilos de Carga de Imagen */
        .file-input-hidden {
            /* Ocultamos el input real */
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        .custom-file-upload {
            border: 2px dashed var(--color-primary);
            background: var(--color-bg-dark);
            color: var(--color-primary);
            padding: 0.75rem;
            display: block; 
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: background 0.3s, color 0.3s;
        }

        .custom-file-upload:hover {
            background: rgba(0, 188, 212, 0.1);
        }

        .image-preview-container {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-bg-dark);
            text-align: center;
        }

        .image-preview-container img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin-top: 0.5rem;
        }
        
        .listado {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .card {
            display: flex;
            flex-direction: column;
            background: var(--color-bg-light);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card-header {
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-primary);
        }

        .card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.95rem;
        }
        
        .card-detail-item strong {
            color: var(--color-text-light);
            margin-right: 5px;
        }

        .card-actions {
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid var(--color-border);
            padding-top: 1rem;
        }

        .card-actions button {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }

        .card-actions .edit {
            background-color: var(--color-secondary);
            color: var(--color-bg-dark);
        }

        .card-actions .delete {
            background-color: var(--color-danger);
            color: var(--color-text-light);
        }


        .loader {
            text-align: center;
            font-weight: 600;
            color: var(--color-secondary);
            margin: 2rem 0;
            font-size: 1.2rem;
            grid-column: 1 / -1; 
        }
        
        /* Dashboard Styles */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }
        
        .kpi-card {
            background: var(--color-bg-dark);
            padding: 1.5rem;
            border-radius: 10px;
            border-left: 5px solid var(--color-primary);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .kpi-card h4 {
            margin-top: 0;
            font-size: 1rem;
            color: var(--color-text-light);
            font-weight: 400;
        }
        
        .kpi-card p {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-primary);
            margin: 0.5rem 0 0 0;
            display: flex;
            align-items: center;
        }
        
        .main-content h2 {
            font-size: 1.8rem;
            color: var(--color-text-light);
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 10px;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    
    <div id="login-container">
        <div class="login-box">
            <h2><i class="fas fa-lock" style="margin-right: 10px; color: var(--color-secondary);"></i> Acceso Restringido</h2>
            <form id="login-form">
                <input type="text" id="username" placeholder="Usuario (admin)" value="admin" required readonly>
                <input type="password" id="password" placeholder="password" required>
                <button type="submit">Ingresar</button>
            </form>
            <p id="login-message" style="color: var(--color-danger); margin-top: 1rem;"></p>
        </div>
    </div>
    
    <div id="admin-content" style="display: none; width: 100%;">
        <button class="menu-toggle" id="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <nav class="sidebar" id="sidebar">
            <div class="logo">Nexus Admin</div>
            <div class="nav-links">
                <button id="btn-dashboard" class="active" onclick="mostrarSeccion('dashboard', this); cerrarSidebar();"><i class="fas fa-chart-line"></i> Dashboard</button> 
                <button id="btn-productos" onclick="mostrarSeccion('productos', this); cerrarSidebar();"><i class="fas fa-box"></i> Productos</button>
                <button id="btn-servicios" onclick="mostrarSeccion('servicios', this); cerrarSidebar();"><i class="fas fa-handshake"></i> Servicios</button>
                <button id="btn-publicidad" onclick="mostrarSeccion('publicidad', this); cerrarSidebar();"><i class="fas fa-ad"></i> Publicidad</button>
                <button class="logout-btn" onclick="logout();"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</button>
            </div>
        </nav>

        <div class="main-content">
            <header>
                <h1 id="current-title">Dashboard</h1>
            </header>

            <div id="dashboard" class="form-section active"></div>
            <div id="productos" class="form-section"></div>
            <div id="servicios" class="form-section"></div>
            <div id="publicidad" class="form-section"></div>
        </div>
    </div>
    
   <script>
    // **********************************************
    // ‚ö†Ô∏è DEBES CAMBIAR ESTAS CONSTANTES:
    // 1. Reemplaza con tu URL de Google Apps Script (terminada en /exec).
    const API_URL = "https://script.google.com/macros/s/AKfycbwhIV3UaX8E4MzAT8L7P6yFkRFnHNx9tlC7xD5SXuxX2AMT8TIZh4jT7ml5L5gX57NLXw/exec"; 
    // 2. Reemplaza con tu clave de la API de ImgBB.
    const API_IMGBB = "86db997f09d5db12c1f731dc79e4d83d"; 
    // **********************************************
    
    // =======================================================
    // üîí L√ìGICA DE SEGURIDAD Y LOGIN (CORREGIDA Y ESTABLE)
    // =======================================================

    // Utilizamos Base64 para ofuscar la clave 'pass' -> 'MTAyNA==' (Arreglo del bloqueo)
    const VALID_PASS_OBFUSCATED = "MTAyNA=="; 
    const VALID_USER = "admin";
    const SESSION_KEY = "admin_logged_in";

    function handleLogin(e) {
        e.preventDefault();
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const message = document.getElementById('login-message');

        const user = usernameInput.value.trim().toLowerCase();
        const pass = passwordInput.value.trim();

        if (user !== VALID_USER) {
            message.textContent = "Usuario incorrecto.";
            return;
        }

        // Chequeo de clave con Base64 (estable y r√°pido)
        try {
            const passwordObfuscated = btoa(pass); 
            if (passwordObfuscated === VALID_PASS_OBFUSCATED) {
                localStorage.setItem(SESSION_KEY, 'true');
                message.textContent = "";
                showAdminPanel();
            } else {
                message.textContent = "Clave incorrecta.";
            }
        } catch (error) {
             message.textContent = "Error al procesar la clave.";
        }
    }

    function checkLogin() {
        if (localStorage.getItem(SESSION_KEY) === 'true') {
            showAdminPanel();
        } else {
            document.getElementById('login-container').classList.remove('hidden');
        }
    }

    function showAdminPanel() {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('admin-content').style.display = 'flex';
        // Mostrar la secci√≥n por defecto despu√©s de cargar (Dashboard)
        mostrarSeccion("dashboard"); 
    }
    
    function logout() {
        localStorage.removeItem(SESSION_KEY);
        window.location.reload(); 
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        checkLogin();
    });


    // =======================================================
    // FUNCIONES CORE
    // =======================================================
    
    let secciones = {
        dashboard: {
            titulo: "Panel de Control y M√©tricas",
            icon: "fas fa-chart-line"
        },
        productos: {
            titulo: "Gesti√≥n de Productos",
            // Campos ajustados para coincidir con la estructura de Google Sheets
            campos: ["Nombre", "Descripci√≥n", "Precio", "Condici√≥n", "Imagen", "Vendedor", "WhatsApp", "Tienda", "DNI", "Ubicaci√≥n", "Tipo", "Categor√≠a", "Env√≠o"],
            icon: "fas fa-box"
        },
        servicios: {
            titulo: "Gesti√≥n de Servicios",
            campos: ["Nombre", "Descripci√≥n", "Precio", "Condici√≥n", "Imagen", "Vendedor", "WhatsApp", "Tienda", "DNI", "Ubicaci√≥n", "Tipo", "Categor√≠a", "Env√≠o"],
            icon: "fas fa-handshake"
        },
        publicidad: {
            titulo: "Gesti√≥n de Publicidad",
            // Campos ajustados para coincidir con la estructura de Google Sheets
            campos: ["T√≠tulo", "Descripci√≥n", "Imagen", "Link", "Posici√≥n", "FechaInicio", "FechaFin", "Estado", "Tipo"],
            icon: "fas fa-ad"
        }
    };

    const formElementsMap = {
        "Descripci√≥n": "textarea",
        "Condici√≥n": ["select", ["Nuevo", "Usado"]],
        "Env√≠o": ["select", ["Gratis", "A coordinar"]],
        "Estado": ["select", ["Activo", "Inactivo"]],
        "Imagen": ["file", "image/*"],
        "FechaInicio": ["date", null],
        "FechaFin": ["date", null],
    };

    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menu-toggle');

    function abrirSidebar() {
        sidebar.classList.add('open');
    }

    function cerrarSidebar() {
        if (window.innerWidth < 992) {
            sidebar.classList.remove('open');
        }
    }

    if (menuToggle) { 
        menuToggle.addEventListener('click', () => {
            if (sidebar.classList.contains('open')) {
                cerrarSidebar();
            } else {
                abrirSidebar();
            }
        });
    }

    function capitalize(s) {
        return s.charAt(0).toUpperCase() + s.slice(1);
    }

    function crearCampo(campo, tipoSeccion) {
        const group = document.createElement('div');
        group.className = 'form-group';

        const label = document.createElement('label');
        label.textContent = campo + ":";
        label.setAttribute('for', `${tipoSeccion}-${campo}`);
        group.appendChild(label);

        let input;
        const config = formElementsMap[campo];
        const elementType = config ? config[0] : "input";
        const elementParams = config ? config[1] : null;

        if (elementType === "textarea") {
            input = document.createElement("textarea");
        } else if (elementType === "select") {
            input = document.createElement("select");
            elementParams.forEach(op => {
                let opt = document.createElement("option");
                opt.value = op;
                opt.textContent = op;
                input.appendChild(opt);
            });
        } else if (elementType === "file") {
            input = document.createElement("input");
            input.type = "file";
            input.accept = elementParams;
            input.onchange = subirImagen; 
            input.className = "file-input-hidden";
            input.id = `${tipoSeccion}-${campo}`;

            const labelButton = document.createElement("label");
            labelButton.htmlFor = `${tipoSeccion}-${campo}`;
            labelButton.className = "custom-file-upload";
            labelButton.innerHTML = `<i class="fas fa-upload"></i> Cargar Imagen`;
            
            group.appendChild(input);
            group.appendChild(labelButton);
            
            return group; 

        } else {
            input = document.createElement("input");
            input.type = elementType === "date" ? "date" : "text";
        }

        input.name = campo;
        input.id = `${tipoSeccion}-${campo}`;
        
        if (campo === "Posici√≥n") {
            input.placeholder = "Posici√≥n Num√©rica (Ej: 1, 3, o dejar vac√≠o)";
            input.type = "number";
            input.min = "1";
        } else {
            input.placeholder = campo === "Tipo" ? tipoSeccion : campo;
        }

        if (campo === "Tipo") {
            // El campo Tipo se auto-rellena con el nombre de la secci√≥n
            input.value = tipoSeccion;
            input.readOnly = true; 
            input.style.opacity = 0.7;
        }

        group.appendChild(input);
        return group;
    }


    function mostrarSeccion(seccion, boton) {
        document.getElementById('current-title').textContent = secciones[seccion].titulo;
        document.querySelectorAll('.nav-links button').forEach(btn => btn.classList.remove('active'));
        if (boton) {
            boton.classList.add('active');
        } else {
            const defaultButton = document.getElementById(`btn-${seccion}`);
            if (defaultButton) {
                defaultButton.classList.add('active');
            }
        }
        
        document.querySelectorAll('.form-section').forEach(div => div.classList.remove('active'));
        const contenedor = document.getElementById(seccion);
        contenedor.classList.add('active');

        if (seccion === 'dashboard') {
            cargarDashboard();
            return; 
        }

        // Cargar el formulario y la lista si es la primera vez que se abre la secci√≥n
        if (!contenedor.dataset.ready) {
            const form = document.createElement("form");
            form.onsubmit = e => guardarItem(e, seccion);

            secciones[seccion].campos.forEach(campo => {
                form.appendChild(crearCampo(campo, seccion));
            });
            
            const actionGroup = document.createElement('div');
            actionGroup.className = 'form-action-group';

            const btn = document.createElement("button");
            btn.type = "submit";
            btn.textContent = "Guardar " + capitalize(seccion.slice(0, -1)); 
            actionGroup.appendChild(btn);
            form.appendChild(actionGroup);

            contenedor.appendChild(form);
            
            const listado = document.createElement("div");
            listado.id = "listado-" + seccion;
            listado.className = "listado";
            contenedor.appendChild(listado);
            contenedor.dataset.ready = "true";
        }

        cargarLista(seccion);
    }

    function subirImagen(e) {
        const input = e.target;
        const file = input.files[0];
        if (!file) return;

        const formGroup = input.parentElement;
        
        const labelButton = formGroup.querySelector('.custom-file-upload');
        if(labelButton) labelButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Subiendo...`;

        const formData = new FormData();
        formData.append("image", file);

        formGroup.querySelector('.loader')?.remove();
        formGroup.querySelector('.image-preview-container')?.remove();

        const loader = document.createElement("div");
        loader.className = "loader";
        loader.textContent = "Procesando imagen... üì∏";
        formGroup.appendChild(loader);

        fetch("https://api.imgbb.com/1/upload?key=" + API_IMGBB, {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            loader.remove();
            if (data.success) {
                const url = data.data.url;
                
                // 1. Quitar el hidden anterior si existe
                let hidden = formGroup.querySelector('input[type="hidden"][name="Imagen"]');
                if(hidden) hidden.remove();
                
                // 2. Crear y a√±adir el nuevo hidden con la URL
                hidden = document.createElement("input");
                hidden.type = "hidden";
                hidden.name = "Imagen"; 
                hidden.value = url;
                formGroup.appendChild(hidden);
                
                // 3. Mostrar preview
                const previewContainer = document.createElement("div");
                previewContainer.className = "image-preview-container";
                previewContainer.innerHTML = `
                    <p style="font-size: 0.9em; margin-bottom: 5px;">‚úÖ Imagen cargada como URL.</p>
                    <img src="${url}" alt="Vista previa de la imagen cargada">
                `;
                formGroup.appendChild(previewContainer);
                
                if(labelButton) labelButton.innerHTML = `<i class="fas fa-check"></i> Imagen Cargada`;

            } else {
                alert("Error al subir imagen: " + data.error.message);
                if(labelButton) labelButton.innerHTML = `<i class="fas fa-upload"></i> Error. Reintentar.`;
            }
        })
        .catch(error => {
            loader.remove();
            console.error("Error en la subida:", error);
            alert("Error de red al subir la imagen.");
            if(labelButton) labelButton.innerHTML = `<i class="fas fa-upload"></i> Error. Reintentar.`;
        });
    }

    function cargarDashboard() {
        const contenedor = document.getElementById("dashboard");
        contenedor.innerHTML = "<div class='loader'><i class='fas fa-spinner fa-spin'></i> Cargando Dashboard...</div>";

        fetch(`${API_URL}?tipo=dashboard`) 
            .then(res => {
                // Manejo de error si la respuesta no es un JSON v√°lido
                return res.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        throw new Error(text || "Error en la respuesta de la API (no JSON).");
                    }
                });
            })
            .then(data => {
                if (data.error) {
                     throw new Error(data.error);
                }
                
                contenedor.innerHTML = '';
                
                // Aseguramos que existan las listas, si no, son arrays vac√≠os
                const productos = data.productos || [];
                const servicios = data.servicios || [];
                const publicidad = data.publicidad || [];
                
                // 1. C√°lculos de M√©tricas
                const productosActivos = productos.filter(p => String(p.Estado || p.Condici√≥n).toLowerCase() === 'activo' || String(p.Estado || p.Condici√≥n).toLowerCase() === 'nuevo').length;
                const productosInactivos = productos.length - productosActivos;
                
                const serviciosActivos = servicios.filter(s => String(s.Estado || s.Condici√≥n).toLowerCase() === 'activo' || String(s.Estado || s.Condici√≥n).toLowerCase() === 'nuevo').length;
                const serviciosInactivos = servicios.length - serviciosActivos;
                
                const publicidadActiva = publicidad.filter(p => String(p.Estado).toLowerCase() === 'activo').length;
                const publicidadInactiva = publicidad.length - publicidadActiva;
                                    
                const totalClicksProductos = productos.reduce((sum, item) => sum + (parseInt(item.Clicks) || 0), 0);
                const totalClicksServicios = servicios.reduce((sum, item) => sum + (parseInt(item.Clicks) || 0), 0);
                const totalClicksPublicidad = publicidad.reduce((sum, item) => sum + (parseInt(item.Clicks) || 0), 0);
                const totalClicksGlobal = totalClicksProductos + totalClicksServicios + totalClicksPublicidad;
                
                
                // 2. Kpis (M√©tricas clave) - Secci√≥n Global
                contenedor.innerHTML += '<h2>M√©tricas Generales</h2>';
                const kpiGridGlobal = document.createElement('div');
                kpiGridGlobal.className = 'kpi-grid';
                kpiGridGlobal.innerHTML = `
                    <div class="kpi-card" style="border-left-color: var(--color-success);">
                        <h4>Items Activos (Total)</h4>
                        <p><i class="fas fa-check-circle"></i> ${productosActivos + serviciosActivos + publicidadActiva}</p>
                    </div>
                    <div class="kpi-card" style="border-left-color: var(--color-secondary);">
                        <h4>Total de Clics (Global)</h4>
                        <p><i class="fas fa-hand-point-up"></i> ${totalClicksGlobal}</p>
                    </div>
                    <div class="kpi-card" style="border-left-color: var(--color-primary);">
                        <h4>Total de Items Registrados</h4>
                        <p><i class="fas fa-database"></i> ${productos.length + servicios.length + publicidad.length}</p>
                    </div>
                `;
                contenedor.appendChild(kpiGridGlobal);
                
                // 3. Desglose por Categor√≠a
                contenedor.innerHTML += '<h2 style="margin-top: 2rem;">Desglose por Categor√≠a</h2>';
                const kpiGridDetail = document.createElement('div');
                kpiGridDetail.className = 'kpi-grid';
                kpiGridDetail.innerHTML = `
                    <div class="kpi-card" style="border-left-color: var(--color-indigo);">
                        <h4>Productos: Activos / Inactivos</h4>
                        <p><span style="color: var(--color-success);">${productosActivos}</span> / <span style="color: var(--color-danger);">${productosInactivos}</span></p>
                    </div>
                    <div class="kpi-card" style="border-left-color: var(--color-indigo);">
                        <h4>Productos: Total Clics</h4>
                        <p><i class="fas fa-hand-point-up" style="color: var(--color-indigo);"></i> ${totalClicksProductos}</p>
                    </div>
                    
                    <div class="kpi-card" style="border-left-color: var(--color-teal);">
                        <h4>Servicios: Activos / Inactivos</h4>
                        <p><span style="color: var(--color-success);">${serviciosActivos}</span> / <span style="color: var(--color-danger);">${serviciosInactivos}</span></p>
                    </div>
                    <div class="kpi-card" style="border-left-color: var(--color-teal);">
                        <h4>Servicios: Total Clics</h4>
                        <p><i class="fas fa-handshake" style="color: var(--color-teal);"></i> ${totalClicksServicios}</p>
                    </div>

                    <div class="kpi-card" style="border-left-color: var(--color-secondary);">
                        <h4>Publicidad: Activa / Inactiva</h4>
                        <p><span style="color: var(--color-success);">${publicidadActiva}</span> / <span style="color: var(--color-danger);">${publicidadInactiva}</span></p>
                    </div>
                    <div class="kpi-card" style="border-left-color: var(--color-secondary);">
                        <h4>Publicidad: Total Clics</h4>
                        <p><i class="fas fa-ad" style="color: var(--color-secondary);"></i> ${totalClicksPublicidad}</p>
                    </div>
                `;
                contenedor.appendChild(kpiGridDetail);
                
                
                // 4. Items M√°s Populares (Top 5 Clics)
                contenedor.innerHTML += '<h2 style="margin-top: 2rem;">Items M√°s Populares (Top 5 Clics)</h2>';
                
                const topItems = [...productos, ...servicios, ...publicidad]
                    .filter(item => (parseInt(item.Clicks) || 0) > 0) 
                    .sort((a, b) => (parseInt(b.Clicks) || 0) - (parseInt(a.Clicks) || 0))
                    .slice(0, 5); 

                const listadoTop = document.createElement('div');
                listadoTop.className = 'listado top-items-list'; 
                
                if (topItems.length === 0) {
                    listadoTop.innerHTML = "<p style='grid-column: 1 / -1; margin-left: 1rem;'>No hay datos de clics disponibles.</p>";
                } else {
                    topItems.forEach((item, index) => {
                        const card = document.createElement("div");
                        card.className = "card";
                        
                        const tipoDisplay = item.Tipo ? item.Tipo.toUpperCase() : (item.Posici√≥n ? 'PUBLICIDAD' : 'N/A');
                        const precioDisplay = item.Precio ? `<strong>Precio:</strong> <span>${item.Precio}</span>` : '';
                        const posicionDisplay = item.Posici√≥n ? `<strong>Posici√≥n:</strong> <span>${item.Posici√≥n}</span>` : '';
                        
                        card.innerHTML = `
                            <div class="card-header">
                                <span class="card-title">${index + 1}. ${item.Nombre || item.T√≠tulo || 'Item sin Nombre'}</span>
                                <span style="font-weight: 700; color: var(--color-secondary);">(${tipoDisplay})</span>
                            </div>
                            <div class="card-details">
                                <div class="card-detail-item">
                                    <strong>Clics:</strong> 
                                    <span style="font-size: 1.1em; color: var(--color-success);">${item.Clicks || 0}</span>
                                </div>
                                <div class="card-detail-item">
                                    ${precioDisplay || posicionDisplay || '<span>---</span>'}
                                </div>
                            </div>
                        `;
                        listadoTop.appendChild(card);
                    });
                }
                contenedor.appendChild(listadoTop);


                // 5. Actividad Reciente (Top 3 Items m√°s Recientes)
                contenedor.innerHTML += '<h2 style="margin-top: 2rem;">√öltimos 3 Items Agregados</h2>';
                
                const allItems = [...productos, ...servicios, ...publicidad];
                // Ordenar por ID (asumiendo que el ID es un timestamp o incremental, para obtener los m√°s recientes)
                const recentItems = allItems
                    .sort((a, b) => (String(b.ID).localeCompare(String(a.ID))))
                    .slice(0, 3); 

                const listadoRecent = document.createElement('div');
                listadoRecent.className = 'listado top-items-list'; 
                
                if (recentItems.length === 0) {
                    listadoRecent.innerHTML = "<p style='grid-column: 1 / -1; margin-left: 1rem;'>No hay √≠tems registrados recientemente.</p>";
                } else {
                    recentItems.forEach((item) => {
                        const card = document.createElement("div");
                        card.className = "card";
                        
                        const tipoDisplay = item.Tipo ? item.Tipo.toUpperCase() : (item.Posici√≥n ? 'PUBLICIDAD' : 'N/A');
                        const nombreDisplay = item.Nombre || item.T√≠tulo || 'Item sin Nombre';
                        const idDisplay = item.ID ? `ID: ${item.ID}` : '';
                        
                        const is_active = String(item.Estado || item.Condici√≥n).toLowerCase() === 'activo' || String(item.Estado || item.Condici√≥n).toLowerCase() === 'nuevo';
                        const status_color = is_active ? 'var(--color-success)' : 'var(--color-danger)';
                        const status_text = item.Estado || item.Condici√≥n || 'N/A';

                        card.innerHTML = `
                            <div class="card-header">
                                <span class="card-title">${nombreDisplay}</span>
                                <span style="font-weight: 700; color: var(--color-primary);">(${tipoDisplay})</span>
                            </div>
                            <div class="card-details">
                                <div class="card-detail-item">
                                    <strong>Tipo:</strong> 
                                    <span>${tipoDisplay}</span>
                                </div>
                                <div class="card-detail-item">
                                    <strong>Estado:</strong> 
                                    <span style="color: ${status_color};">${status_text}</span>
                                </div>
                                <div class="card-detail-item" style="grid-column: 1 / -1; font-size: 0.8em; color: var(--color-text-light);">
                                    ${idDisplay}
                                </div>
                            </div>
                        `;
                        listadoRecent.appendChild(card);
                    });
                }
                contenedor.appendChild(listadoRecent);


            })
            .catch(error => {
                console.error("Error al cargar el dashboard:", error);
                contenedor.innerHTML = `<div class='loader' style="color:var(--color-danger); white-space: pre-wrap;">‚ö†Ô∏è **ERROR CR√çTICO AL CARGAR DASHBOARD:** ${error.message}</div>`;
            });
    }

    function guardarItem(e, tipo) {
        e.preventDefault();
        const form = e.target;
        const data = {};
        [...form.elements].forEach(el => {
            if (el.name && el.type !== "file") {
                data[el.name] = el.value;
            }
        });

        const isEditing = data.ID;
        const action = isEditing ? 'editar' : 'guardar';

        const btn = form.querySelector('button[type="submit"]');
        btn.textContent = isEditing ? "Actualizando..." : "Guardando...";
        btn.disabled = true;

        fetch(`${API_URL}?tipo=${tipo}&accion=${action}`, {
            method: "POST",
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify(data)
        })
        .then(res => res.text())
        .then(() => {
            alert(isEditing ? "Actualizado correctamente ‚úÖ" : "Guardado correctamente ‚úÖ");
            form.reset();
            // Limpiar previews e inputs ocultos despu√©s de guardar
            form.querySelectorAll('.image-preview-container, input[type="hidden"][name="Imagen"], input[name="ID"]').forEach(el => el.remove());
            
            const imageLabel = form.querySelector('.custom-file-upload');
            if(imageLabel) imageLabel.innerHTML = `<i class="fas fa-upload"></i> Cargar Imagen`;

            cargarLista(tipo);
        })
        .catch(error => {
            console.error("Error al guardar/actualizar:", error);
            alert("Error al intentar guardar. Verifique la conexi√≥n o la configuraci√≥n del App Script.");
        })
        .finally(() => {
            btn.textContent = isEditing ? "Actualizar " + capitalize(tipo.slice(0, -1)) : "Guardar " + capitalize(tipo.slice(0, -1));
            btn.disabled = false;
        });
    }

    function cargarLista(tipo) {
        const contenedor = document.getElementById("listado-" + tipo);
        if (!contenedor) return; 

        contenedor.innerHTML = "<div class='loader'><i class='fas fa-spinner fa-spin'></i> Cargando datos...</div>";

        fetch(`${API_URL}?tipo=${tipo}`)
            .then(res => {
                if (!res.ok) throw new Error("Error de red o CORS bloqueado.");
                return res.text().then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                         throw new Error(text || "Error en la respuesta de la API (no JSON).");
                    }
                });
            })
            .then(items => {
                contenedor.innerHTML = "";
                if (items.length === 0) {
                    contenedor.innerHTML = "<div class='loader'>No hay items registrados.</div>";
                    return;
                }
                
                items.forEach((item, index) => {
                    const card = document.createElement("div");
                    card.className = "card";

                    let infoHTML;
                    
                    if (tipo === 'publicidad') {
                        // **CORRECCI√ìN IMPLEMENTADA:** Usamos el √≠ndice como fallback para el t√≠tulo.
                        const tituloDisplay = item.T√≠tulo || `Anuncio #${index + 1}`; 
                        
                        infoHTML = `
                            <div class="card-header">
                                <span class="card-title">${tituloDisplay}</span>
                                <span style="font-weight: 700; color: var(--color-primary); font-size: 0.9em;">PUBLICIDAD</span>
                            </div>
                            <div class="card-details">
                                <div class="card-detail-item"><strong>Estado:</strong> ${item.Estado || 'N/A'}</div>
                                <div class="card-detail-item"><strong>Posici√≥n:</strong> ${item.Posici√≥n || 'N/A'}</div>
                                <div class="card-detail-item"><strong>Inicio:</strong> ${item.FechaInicio ? new Date(item.FechaInicio).toLocaleDateString() : 'N/A'}</div>
                                <div class="card-detail-item"><strong>Fin:</strong> ${item.FechaFin ? new Date(item.FechaFin).toLocaleDateString() : 'N/A'}</div>
                                <div class="card-detail-item"><strong>Clics:</strong> ${item.Clicks || 0}</div>
                            </div>
                        `;
                    } else {
                        // Productos y Servicios
                        const clicksHtml = item.Clicks ? `<div class="card-detail-item"><strong>Clics:</strong> ${item.Clicks}</div>` : '';
                        const vendedorHtml = item.Vendedor ? `<div class="card-detail-item"><strong>Vendedor:</strong> ${item.Vendedor}</div>` : '';
                        const tipoDisplay = item.Tipo ? item.Tipo.toUpperCase() : 'N/A';
                        
                        infoHTML = `
                            <div class="card-header">
                                <span class="card-title">${item.Nombre || 'Item sin Nombre'}</span>
                                <span style="font-weight: 700; color: var(--color-primary); font-size: 0.9em;">${tipoDisplay}</span>
                            </div>
                            <div class="card-details">
                                <div class="card-detail-item"><strong>Precio:</strong> ${item.Precio || 'N/A'}</div>
                                <div class="card-detail-item"><strong>Estado:</strong> ${item.Condici√≥n || item.Estado || 'N/A'}</div>
                                ${clicksHtml}
                                ${vendedorHtml}
                            </div>
                        `;
                    }
                    
                    const info = document.createElement("div");
                    info.innerHTML = infoHTML;

                    const actions = document.createElement("div");
                    actions.className = "card-actions";

                    const btnEditar = document.createElement("button");
                    btnEditar.textContent = "Editar";
                    btnEditar.className = "edit";
                    btnEditar.onclick = () => editarItem(item, tipo);

                    const btnEliminar = document.createElement("button");
                    btnEliminar.textContent = "Eliminar";
                    btnEliminar.className = "delete";
                    btnEliminar.onclick = () => eliminarItem(item.ID, tipo);

                    actions.append(btnEditar, btnEliminar);

                    card.append(info, actions);
                    contenedor.appendChild(card);
                });
            })
            .catch(error => {
                console.error("Error al cargar la lista:", error);
                contenedor.innerHTML = `<div class='loader' style="color:var(--color-danger); white-space: pre-wrap;">‚ö†Ô∏è **ERROR AL CARGAR DATOS:** ${error.message}</div>`;
            });
    }

    function editarItem(item, tipo) {
        const contenedor = document.getElementById(tipo);
        const form = contenedor.querySelector("form");
        form.scrollIntoView({ behavior: 'smooth' }); 

        // Limpiar elementos de edici√≥n anteriores
        form.querySelectorAll('.image-preview-container, input[type="hidden"][name="Imagen"], input[name="ID"]').forEach(el => el.remove());
        
        const imageLabel = form.querySelector('.custom-file-upload');
        if(imageLabel) imageLabel.innerHTML = `<i class="fas fa-upload"></i> Cargar Imagen`;


        secciones[tipo].campos.forEach(campo => {
            const input = form.querySelector(`[name="${campo}"]`);
            if (input) {
                if (campo === "Imagen") {
                    if (item.Imagen) {
                        // Mantener la URL de la imagen actual en un campo oculto
                        let hidden = document.createElement("input");
                        hidden.type = "hidden";
                        hidden.name = "Imagen";
                        hidden.value = item.Imagen;
                        input.parentElement.appendChild(hidden);

                        // Mostrar la vista previa
                        const previewContainer = document.createElement("div");
                        previewContainer.className = "image-preview-container";
                        previewContainer.innerHTML = `<p style="font-size: 0.9em; margin-bottom: 5px;">üñºÔ∏è Imagen actual. Sube una nueva para reemplazar.</p><img src="${item.Imagen}" alt="Imagen actual">`;
                        input.parentElement.appendChild(previewContainer);
                        
                        if(imageLabel) imageLabel.innerHTML = `<i class="fas fa-sync-alt"></i> Cambiar Imagen`;

                    }
                    // Limpiar el input de tipo file para que no se env√≠e un archivo vac√≠o
                    input.value = ''; 
                } else {
                    input.value = item[campo] || "";
                }
            }
        });

        // A√±adir el ID para indicar que es una edici√≥n
        let hiddenID = document.createElement("input");
        hiddenID.type = "hidden";
        hiddenID.name = "ID";
        hiddenID.value = item.ID;
        form.appendChild(hiddenID);
        
        const btn = form.querySelector('button[type="submit"]');
        btn.textContent = "Actualizar " + capitalize(tipo.slice(0, -1));
    }


    function eliminarItem(id, tipo) {
        if (!confirm("‚ö†Ô∏è ¬øEst√°s seguro de que quieres eliminar este item de forma permanente?")) return;
        fetch(`${API_URL}?tipo=${tipo}&accion=eliminar&id=${id}`, {
            method: "POST"
        })
        .then(res => res.text())
        .then(() => {
            alert("Eliminado correctamente üóëÔ∏è");
            cargarLista(tipo);
        })
        .catch(error => {
            console.error("Error al eliminar:", error);
            alert("Error al intentar eliminar. Verifique la conexi√≥n.");
        });
    }

</script>
</body>
</html>
